---
interface Props {
  src: string;
  title: string;
}

const { src, title } = Astro.props;
---

<div class="pdf-carousel" data-pdf-src={src}>
  <div class="pdf-header">
    <div class="pdf-info">
      <span class="pdf-icon">ðŸ“„</span>
      <span class="pdf-title">{title}</span>
    </div>
    <a href={src} target="_blank" rel="noopener noreferrer" class="pdf-download-btn">
      <span class="download-icon">â†“</span>
      Download PDF
    </a>
  </div>

  <div class="pdf-viewport">
    <button class="nav-btn nav-prev" disabled aria-label="Previous page">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <polyline points="15 18 9 12 15 6"></polyline>
      </svg>
    </button>

    <div class="pdf-slide-container">
      <div class="pdf-slide-track">
        <canvas class="pdf-canvas"></canvas>
      </div>
    </div>

    <button class="nav-btn nav-next" aria-label="Next page">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <polyline points="9 18 15 12 9 6"></polyline>
      </svg>
    </button>
  </div>

  <div class="pdf-controls">
    <div class="page-indicator">
      <span class="current-page">1</span>
      <span class="page-sep">/</span>
      <span class="total-pages">--</span>
    </div>
  </div>

  <div class="pdf-loading">
    <div class="loading-spinner"></div>
    <span>Loading PDF...</span>
  </div>

  <div class="pdf-fallback">
    <p>Unable to load PDF. <a href={src} target="_blank" rel="noopener noreferrer">Click here to download</a>.</p>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const pdfjsLib = (window as any).pdfjsLib;

    if (!pdfjsLib) {
      console.error('PDF.js library not loaded');
      document.querySelectorAll('.pdf-carousel').forEach((el) => {
        const fallback = el.querySelector('.pdf-fallback') as HTMLElement;
        const loading = el.querySelector('.pdf-loading') as HTMLElement;
        if (fallback) fallback.style.display = 'block';
        if (loading) loading.style.display = 'none';
      });
      return;
    }

    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

    document.querySelectorAll('.pdf-carousel').forEach((container) => {
      initCarousel(container as HTMLElement, pdfjsLib);
    });
  });

  async function initCarousel(container: HTMLElement, pdfjsLib: any) {
    const pdfSrc = container.dataset.pdfSrc;
    if (!pdfSrc) return;

    const canvas = container.querySelector('.pdf-canvas') as HTMLCanvasElement;
    const ctx = canvas.getContext('2d')!;
    const slideTrack = container.querySelector('.pdf-slide-track') as HTMLElement;
    const prevBtn = container.querySelector('.nav-prev') as HTMLButtonElement;
    const nextBtn = container.querySelector('.nav-next') as HTMLButtonElement;
    const currentPageEl = container.querySelector('.current-page') as HTMLElement;
    const totalPagesEl = container.querySelector('.total-pages') as HTMLElement;
    const loadingEl = container.querySelector('.pdf-loading') as HTMLElement;
    const fallbackEl = container.querySelector('.pdf-fallback') as HTMLElement;
    const viewport = container.querySelector('.pdf-viewport') as HTMLElement;

    let pdfDoc: any = null;
    let currentPage = 1;
    let totalPages = 0;
    let isRendering = false;
    let pendingPage: number | null = null;

    try {
      pdfDoc = await pdfjsLib.getDocument(pdfSrc).promise;
      totalPages = pdfDoc.numPages;
      totalPagesEl.textContent = String(totalPages);

      loadingEl.style.display = 'none';
      viewport.style.display = 'flex';

      await renderPage(currentPage);

      prevBtn.addEventListener('click', goToPrev);
      nextBtn.addEventListener('click', goToNext);

      updateButtons();
    } catch (error) {
      console.error('Error loading PDF:', error);
      loadingEl.style.display = 'none';
      fallbackEl.style.display = 'block';
    }

    async function renderPage(pageNum: number) {
      if (isRendering) {
        pendingPage = pageNum;
        return;
      }

      isRendering = true;

      try {
        const page = await pdfDoc.getPage(pageNum);

        const slideContainer = container.querySelector('.pdf-slide-container') as HTMLElement;
        const containerWidth = slideContainer.clientWidth - 40;
        const pageViewport = page.getViewport({ scale: 1 });
        const scale = Math.min(containerWidth / pageViewport.width, 1.5);

        const scaledViewport = page.getViewport({ scale });

        canvas.height = scaledViewport.height;
        canvas.width = scaledViewport.width;

        await page.render({
          canvasContext: ctx,
          viewport: scaledViewport,
        }).promise;

        currentPage = pageNum;
        currentPageEl.textContent = String(pageNum);
        updateButtons();
      } catch (err) {
        console.error('Error rendering page:', err);
      }

      isRendering = false;

      if (pendingPage !== null) {
        const pending = pendingPage;
        pendingPage = null;
        renderPage(pending);
      }
    }

    function goToPrev() {
      if (currentPage <= 1) return;
      animateSlide('right');
      setTimeout(() => renderPage(currentPage - 1), 150);
    }

    function goToNext() {
      if (currentPage >= totalPages) return;
      animateSlide('left');
      setTimeout(() => renderPage(currentPage + 1), 150);
    }

    function animateSlide(direction: 'left' | 'right') {
      slideTrack.classList.remove('slide-left', 'slide-right');
      void slideTrack.offsetWidth;
      slideTrack.classList.add(`slide-${direction}`);

      setTimeout(() => {
        slideTrack.classList.remove('slide-left', 'slide-right');
      }, 300);
    }

    function updateButtons() {
      prevBtn.disabled = currentPage <= 1;
      nextBtn.disabled = currentPage >= totalPages;
    }
  }
</script>

<style>
  .pdf-carousel {
    margin: 1.5rem 0;
    background: color-mix(in srgb, currentColor 3%, transparent);
    border: 1px solid color-mix(in srgb, currentColor 10%, transparent);
    border-radius: 6px;
    overflow: hidden;
  }

  .pdf-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.75rem 1rem;
    background: color-mix(in srgb, currentColor 5%, transparent);
    border-bottom: 1px solid color-mix(in srgb, currentColor 10%, transparent);
  }

  .pdf-info {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.85rem;
    font-weight: 500;
  }

  .pdf-icon {
    font-size: 1rem;
  }

  .pdf-title {
    opacity: 0.9;
  }

  .pdf-download-btn {
    display: flex;
    align-items: center;
    gap: 0.4rem;
    padding: 0.4rem 0.75rem;
    font-size: 0.75rem;
    color: currentColor;
    text-decoration: none;
    background: color-mix(in srgb, currentColor 5%, transparent);
    border: 1px solid color-mix(in srgb, currentColor 15%, transparent);
    border-radius: 4px;
    transition: all 0.2s ease;
  }

  .pdf-download-btn:hover {
    background: color-mix(in srgb, #10b981 10%, transparent);
    border-color: #10b981;
    color: #10b981;
  }

  .download-icon {
    font-weight: bold;
  }

  .pdf-viewport {
    display: none;
    align-items: center;
    gap: 0.5rem;
    padding: 1rem;
    min-height: 400px;
  }

  .nav-btn {
    flex-shrink: 0;
    width: 44px;
    height: 44px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: color-mix(in srgb, currentColor 8%, transparent);
    border: 1px solid color-mix(in srgb, currentColor 15%, transparent);
    border-radius: 50%;
    color: currentColor;
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .nav-btn:hover:not(:disabled) {
    background: color-mix(in srgb, #10b981 15%, transparent);
    border-color: #10b981;
    color: #10b981;
    transform: scale(1.05);
  }

  .nav-btn:disabled {
    opacity: 0.3;
    cursor: not-allowed;
  }

  .nav-btn svg {
    width: 20px;
    height: 20px;
  }

  .pdf-slide-container {
    flex: 1;
    overflow: hidden;
    display: flex;
    justify-content: center;
    align-items: center;
    background: color-mix(in srgb, currentColor 2%, transparent);
    border-radius: 4px;
    min-height: 380px;
  }

  .pdf-slide-track {
    display: flex;
    justify-content: center;
    transition: transform 0.3s ease, opacity 0.3s ease;
  }

  .pdf-slide-track.slide-left {
    animation: slideOutLeft 0.15s ease forwards, slideInRight 0.15s ease 0.15s forwards;
  }

  .pdf-slide-track.slide-right {
    animation: slideOutRight 0.15s ease forwards, slideInLeft 0.15s ease 0.15s forwards;
  }

  @keyframes slideOutLeft {
    from { transform: translateX(0); opacity: 1; }
    to { transform: translateX(-30px); opacity: 0; }
  }

  @keyframes slideInRight {
    from { transform: translateX(30px); opacity: 0; }
    to { transform: translateX(0); opacity: 1; }
  }

  @keyframes slideOutRight {
    from { transform: translateX(0); opacity: 1; }
    to { transform: translateX(30px); opacity: 0; }
  }

  @keyframes slideInLeft {
    from { transform: translateX(-30px); opacity: 0; }
    to { transform: translateX(0); opacity: 1; }
  }

  .pdf-canvas {
    max-width: 100%;
    height: auto;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
    border-radius: 2px;
  }

  .pdf-controls {
    display: flex;
    justify-content: center;
    padding: 0.75rem 1rem;
    border-top: 1px solid color-mix(in srgb, currentColor 10%, transparent);
    background: color-mix(in srgb, currentColor 3%, transparent);
  }

  .page-indicator {
    display: flex;
    align-items: center;
    gap: 0.35rem;
    font-size: 0.85rem;
    font-weight: 500;
    font-family: "IBM Plex Mono", monospace;
  }

  .current-page {
    color: #10b981;
  }

  .page-sep {
    opacity: 0.5;
  }

  .total-pages {
    opacity: 0.7;
  }

  .pdf-loading {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 1rem;
    padding: 3rem;
    color: currentColor;
    opacity: 0.6;
    font-size: 0.85rem;
  }

  .loading-spinner {
    width: 32px;
    height: 32px;
    border: 3px solid color-mix(in srgb, currentColor 20%, transparent);
    border-top-color: #10b981;
    border-radius: 50%;
    animation: spin 1s linear infinite;
  }

  @keyframes spin {
    to { transform: rotate(360deg); }
  }

  .pdf-fallback {
    display: none;
    padding: 2rem;
    text-align: center;
    font-size: 0.85rem;
    opacity: 0.7;
  }

  .pdf-fallback a {
    color: #10b981;
    text-decoration: underline;
  }

  @media (max-width: 640px) {
    .pdf-header {
      flex-direction: column;
      gap: 0.75rem;
      align-items: flex-start;
    }

    .pdf-viewport {
      padding: 0.75rem 0.5rem;
      gap: 0.25rem;
    }

    .nav-btn {
      width: 36px;
      height: 36px;
    }

    .nav-btn svg {
      width: 16px;
      height: 16px;
    }

    .pdf-slide-container {
      min-height: 300px;
    }
  }
</style>
